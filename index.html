<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Rezept-Erfasser</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 40px auto;
    }
    input, select {
      padding: 5px;
      margin: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>

  <h1>Rezept-Erfasser</h1>

  <label for="image">Bild hochladen:</label><br>
  <input type="file" id="image" accept="image/*"><br><br>

  <label for="dishType">Gerichtstyp:</label>
  <select id="dishType">
    <option>Hauptgericht</option>
    <option>Suppe</option>
    <option>Salat</option>
    <option>Dessert</option>
    <option>Snack</option>
    <option>Sonstiges</option>
  </select><br><br>

  <label for="portions">Portionen:</label>
  <input type="number" id="portions" min="1" value="1"><br><br>

  <h3>Zutatenliste</h3>
  <table id="ingredientsTable">
    <thead>
      <tr>
        <th>Zutat</th>
        <th>Menge</th>
        <th>Einheit</th>
        <th>Entfernen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addIngredient()">Zutat hinzufügen</button>
  <button onclick="exportJSON()">JSON speichern</button>

  <script>
    function addIngredient() {
      const table = document.getElementById("ingredientsTable").getElementsByTagName('tbody')[0];
      const row = table.insertRow();

      const cell1 = row.insertCell(0);
      const inputName = document.createElement("input");
      inputName.type = "text";
      cell1.appendChild(inputName);

      const cell2 = row.insertCell(1);
      const inputAmount = document.createElement("input");
      inputAmount.type = "number";
      inputAmount.min = "0";
      cell2.appendChild(inputAmount);

      const cell3 = row.insertCell(2);
      const selectUnit = document.createElement("select");
      ["g", "ml", "Stück", "TL", "EL", "Tasse", "Scheibe", "Prise"].forEach(unit => {
        const option = document.createElement("option");
        option.value = unit;
        option.text = unit;
        selectUnit.appendChild(option);
      });
      cell3.appendChild(selectUnit);

      const cell4 = row.insertCell(3);
      const delButton = document.createElement("button");
      delButton.textContent = "✖";
      delButton.onclick = () => row.remove();
      cell4.appendChild(delButton);
    }

    function exportJSON() {
      const dishType = document.getElementById("dishType").value;
      const portions = parseInt(document.getElementById("portions").value, 10);

      const imageInput = document.getElementById("image");
      const imageName = imageInput.files.length > 0 ? imageInput.files[0].name : "kein_bild.jpg";

      const table = document.getElementById("ingredientsTable").getElementsByTagName('tbody')[0];
      const rows = table.getElementsByTagName('tr');

      const ingredients = [];

      for (let row of rows) {
        const name = row.cells[0].querySelector('input').value.trim();
        const amount = parseFloat(row.cells[1].querySelector('input').value);
        const unit = row.cells[2].querySelector('select').value;

        if (name && !isNaN(amount)) {
          ingredients.push({ name, amount, unit });
        }
      }

      const data = {
        image_id: imageName,
        view_angle: "45_degree",
        full_plate: true,
        no_foreign_objects: true,
        dish_type: dishType,
        portions: portions,
        ingredients: ingredients
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "rezept.json";
      a.click();
    }
  </script>

</body>
</html>
