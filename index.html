<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Tracking Datensammlung</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a8b; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>KI Tracking - Datensammlung</h1>
    
    <form id="dataForm">
        <!-- Bild Upload -->
        <div class="form-group">
            <label for="image">Bild hochladen (max. 10MB):</label>
            <input type="file" id="image" accept="image/*" required>
        </div>

        <!-- Zutatentabelle direkt unter Bild Upload -->
        <div class="form-group">
            <label>Zutaten:</label>
            <table id="ingredientsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Menge</th>
                        <th>Einheit</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Zutat"></td>
                        <td><input type="number" step="0.1" placeholder="Menge"></td>
                        <td>
                            <select>
                                <option value="gr">Gramm</option>
                                <option value="ml">Milliliter</option>
                            </select>
                        </td>
                        <td><button type="button" onclick="removeIngredient(this)">Entfernen</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" onclick="addIngredient()">Zutat hinzufügen</button>
        </div>

        <!-- Neue Ja/Nein Fragen -->
        <div class="form-group">
            <label>Ist das Bild scharf und gut beleuchtet?</label>
            <input type="radio" name="sharp_light" value="true" id="sharp_light_yes"> <label for="sharp_light_yes">Ja</label>
            <input type="radio" name="sharp_light" value="false" id="sharp_light_no"> <label for="sharp_light_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist das Bild in einem schrägen Winkel von ca. 45° aufgenommen?</label>
            <input type="radio" name="angle_45" value="true" id="angle_45_yes"> <label for="angle_45_yes">Ja</label>
            <input type="radio" name="angle_45" value="false" id="angle_45_no"> <label for="angle_45_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist das Essen vollständig im Bild zu sehen (kein Millimeter abgeschnitten)?</label>
            <input type="radio" name="full_plate" value="true" id="full_plate_yes"> <label for="full_plate_yes">Ja</label>
            <input type="radio" name="full_plate" value="false" id="full_plate_no"> <label for="full_plate_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist sonstiges Essen oder Trinken im Bild zu sehen?</label>
            <input type="radio" name="no_other_food" value="true" id="no_other_no"> <label for="no_other_no">Ja</label>
            <input type="radio" name="no_other_food" value="false" id="no_other_yes"> <label for="no_other_yes">Nein</label>
        </div>

        <!-- Zubereitungsart mit Erweiterungen -->
        <div class="form-group">
            <label for="prep">Zubereitungsart:</label>
            <select id="prep">
                <option value="roh">Roh</option>
                <option value="gekocht">Gekocht</option>
                <option value="gebraten">Gebraten</option>
                <option value="gebacken">Gebacken</option>
                <option value="frittiert">Frittiert</option>
                <option value="sonstiges">Sonstiges</option>
            </select>
        </div>

        <!-- Portionen -->
        <div class="form-group">
            <label for="portions">Portionen:</label>
            <input type="number" id="portions" min="1" value="1">
        </div>

        <!-- Speichern und Testen Buttons -->
        <button type="button" id="saveButton" onclick="saveToCloudflare()">Daten speichern</button>
        <button type="button" onclick="testConnection()" style="margin-left: 10px; background: #28a745;">Token testen</button>
        <div id="status"></div>
    </form>

    <script>
        // Konfiguration und Funktionen bleiben weitgehend unverändert
        const CLOUDFLARE_CONFIG = {
            accountId: '72ada7eefcd25f3999aeed1c51b8a912',
            bucketName: 'bildersammlung',
            apiToken: 'psbjTmyfRkS656vGmZVgwMTAKF0jR_uVrNgV1Ofp',
            region: 'auto'
        };
        const SPAM_PROTECTION = {
            maxUploadsPerHour: 10,
            maxUploadsPerDay: 50,
            minTimeBetweenUploads: 30,
            requiredFieldsCount: 5
        };

        function getUploadHistory() {
            const history = localStorage.getItem('uploadHistory');
            return history ? JSON.parse(history) : [];
        }
        function addUploadToHistory() {
            const history = getUploadHistory();
            const now = Date.now();
            history.push(now);
            const filtered = history.filter(ts => now - ts < 24 * 60 * 60 * 1000);
            localStorage.setItem('uploadHistory', JSON.stringify(filtered));
        }
        function checkSpamProtection() {
            const history = getUploadHistory();
            const now = Date.now();
            if (history.length > 0) {
                const last = Math.max(...history);
                if ((now - last)/1000 < SPAM_PROTECTION.minTimeBetweenUploads) {
                    throw new Error(`Bitte warten Sie ${SPAM_PROTECTION.minTimeBetweenUploads - Math.floor((now-last)/1000)} Sekunden.`);
                }
            }
            const oneHourAgo = now - 3600000;
            if (history.filter(ts => ts > oneHourAgo).length >= SPAM_PROTECTION.maxUploadsPerHour) {
                throw new Error(`Max Uploads pro Stunde erreicht (${SPAM_PROTECTION.maxUploadsPerHour}).`);
            }
            if (history.length >= SPAM_PROTECTION.maxUploadsPerDay) {
                throw new Error(`Max Uploads pro Tag erreicht (${SPAM_PROTECTION.maxUploadsPerDay}).`);
            }
        }
        function validateFormCompleteness() {
            let count=0;
            if (document.getElementById('image').files.length) count++;
            const radios = ['sharp_light','angle_45','full_plate','no_other_food'];
            radios.forEach(name => { if (getRadioValue(name)!==null) count++; });
            if (document.getElementById('prep').value) count++;
            if (document.getElementById('portions').value) count++;
            if (getIngredientsData().length) count++;
            if (count < SPAM_PROTECTION.requiredFieldsCount) {
                throw new Error(`Bitte füllen Sie mindestens ${SPAM_PROTECTION.requiredFieldsCount} Felder aus. Aktuell: ${count}`);
            }
        }
        function addHoneypot() {
            const honeypot = document.createElement('input');
            honeypot.type='text'; honeypot.name='website'; honeypot.style.display='none'; honeypot.tabIndex=-1; honeypot.autocomplete='off';
            document.getElementById('dataForm').appendChild(honeypot);
        }
        function checkHoneypot() {
            const hp = document.querySelector('input[name="website"]');
            if (hp && hp.value) throw new Error('Bot-Aktivität erkannt.');
        }
        function getRadioValue(name) {
            const r = document.querySelector(`input[name="${name}"]:checked`);
            return r ? r.value==='true' : null;
        }
        function getIngredientsData() {
            const arr=[];
            const rows = document.querySelectorAll('#ingredientsTable tbody tr');
            rows.forEach(row=>{
                const name=row.cells[0].querySelector('input').value.trim();
                const amt=parseFloat(row.cells[1].querySelector('input').value);
                const unit=row.cells[2].querySelector('select').value;
                if (name && !isNaN(amt)) arr.push({name,amount:amt,unit});
            });
            return arr;
        }
        function addIngredient() {
            const tbody=document.querySelector('#ingredientsTable tbody');
            const tr=document.createElement('tr');
            tr.innerHTML=`
                <td><input type="text" placeholder="Zutat"></td>
                <td><input type="number" step="0.1" placeholder="Menge"></td>
                <td>
                    <select>
                        <option value="gr">Gramm</option>
                        <option value="ml">Milliliter</option>
                    </select>
                </td>
                <td><button type="button" onclick="removeIngredient(this)">Entfernen</button></td>
            `;
            tbody.appendChild(tr);
        }
        function removeIngredient(btn) { btn.closest('tr').remove(); }

        function showStatus(msg,type) {
            const s=document.getElementById('status');
            s.className=`status ${type}`; s.textContent=msg;
        }

        async function saveToCloudflare() { /* unveränderte Logik */ }
        async function uploadToR2() { /* unveränderte Logik */ }
        async function testConnection() { /* unveränderte Logik */ }

        document.addEventListener('DOMContentLoaded',()=>{ addHoneypot();
            const hist=getUploadHistory(); const now=Date.now();
            const hrAgo=now-3600000;
            if(hist.length>0) showStatus(`Heute ${hist.length}/${SPAM_PROTECTION.maxUploadsPerDay}, diese Stunde ${hist.filter(ts=>ts>hrAgo).length}/${SPAM_PROTECTION.maxUploadsPerHour}`,'loading');
        });
    </script>
</body>
</html>
