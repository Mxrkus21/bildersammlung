<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Tracking Datensammlung</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a8b; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>KI Tracking - Datensammlung</h1>
    <form id="dataForm">
        <div class="form-group">
            <label for="image">Bild hochladen (max. 10MB):</label>
            <input type="file" id="image" accept="image/*" required>
        </div>
        <div class="form-group">
            <label>Zutaten:</label>
            <table id="ingredientsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Menge</th>
                        <th>Einheit</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Zutat"></td>
                        <td><input type="number" step="0.1" placeholder="Menge"></td>
                        <td>
                            <select>
                                <option value="gr">Gramm</option>
                                <option value="ml">Milliliter</option>
                            </select>
                        </td>
                        <td><button type="button" onclick="removeIngredient(this)">Entfernen</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" onclick="addIngredient()">Zutat hinzufügen</button>
        </div>
        <div class="form-group">
            <label>Ist das Bild scharf und gut beleuchtet?</label>
            <input type="radio" name="sharp_light" value="true" id="sharp_light_yes"> <label for="sharp_light_yes">Ja</label>
            <input type="radio" name="sharp_light" value="false" id="sharp_light_no"> <label for="sharp_light_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist das Bild in einem schrägen Winkel von ca. 45° aufgenommen?</label>
            <input type="radio" name="angle_45" value="true" id="angle_45_yes"> <label for="angle_45_yes">Ja</label>
            <input type="radio" name="angle_45" value="false" id="angle_45_no"> <label for="angle_45_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist das Essen vollständig im Bild zu sehen (kein Millimeter abgeschnitten)?</label>
            <input type="radio" name="full_plate" value="true" id="full_plate_yes"> <label for="full_plate_yes">Ja</label>
            <input type="radio" name="full_plate" value="false" id="full_plate_no"> <label for="full_plate_no">Nein</label>
        </div>
        <div class="form-group">
            <label>Ist sonstiges Essen oder Trinken im Bild zu sehen?</label>
            <input type="radio" name="no_other_food" value="true" id="no_other_no"> <label for="no_other_no">Ja</label>
            <input type="radio" name="no_other_food" value="false" id="no_other_yes"> <label for="no_other_yes">Nein</label>
        </div>
        <div class="form-group">
            <label for="prep">Zubereitungsart:</label>
            <select id="prep">
                <option value="roh">Roh</option>
                <option value="gekocht">Gekocht</option>
                <option value="gebraten">Gebraten</option>
                <option value="gebacken">Gebacken</option>
                <option value="frittiert">Frittiert</option>
                <option value="sonstiges">Sonstiges</option>
            </select>
        </div>
        <div class="form-group">
            <label for="portions">Portionen:</label>
            <input type="number" id="portions" min="1" value="1">
        </div>
        <button type="button" id="saveButton" onclick="saveToCloudflare()">Daten speichern</button>
        <button type="button" onclick="testConnection()" style="margin-left: 10px; background: #28a745;">Token testen</button>
        <div id="status"></div>
    </form>
    <script>
        const CLOUDFLARE_CONFIG = {
            accountId: '72ada7eefcd25f3999aeed1c51b8a912',
            bucketName: 'bildersammlung',
            apiToken: 'psbjTmyfRkS656vGmZVgwMTAKF0jR_uVrNgV1Ofp',
            region: 'auto'
        };
        const SPAM_PROTECTION = {
            maxUploadsPerHour: 10,
            maxUploadsPerDay: 50,
            minTimeBetweenUploads: 30,
            requiredFieldsCount: 5
        };
        function getUploadHistory() {
            const history = localStorage.getItem('uploadHistory');
            return history ? JSON.parse(history) : [];
        }
        function addUploadToHistory() {
            const history = getUploadHistory();
            const now = Date.now();
            history.push(now);
            const filtered = history.filter(timestamp => now - timestamp < 24 * 60 * 60 * 1000);
            localStorage.setItem('uploadHistory', JSON.stringify(filtered));
        }
        function checkSpamProtection() {
            const history = getUploadHistory();
            const now = Date.now();
            if (history.length > 0) {
                const lastUpload = Math.max(...history);
                const timeSince = (now - lastUpload) / 1000;
                if (timeSince < SPAM_PROTECTION.minTimeBetweenUploads) {
                    throw new Error(`Bitte warten Sie ${SPAM_PROTECTION.minTimeBetweenUploads - Math.floor(timeSince)} Sekunden.`);
                }
            }
            const oneHourAgo = now - (60 * 60 * 1000);
            if (history.filter(timestamp => timestamp > oneHourAgo).length >= SPAM_PROTECTION.maxUploadsPerHour) {
                throw new Error(`Maximale Anzahl Uploads pro Stunde erreicht (${SPAM_PROTECTION.maxUploadsPerHour}).`);
            }
            if (history.length >= SPAM_PROTECTION.maxUploadsPerDay) {
                throw new Error(`Maximale Anzahl Uploads pro Tag erreicht (${SPAM_PROTECTION.maxUploadsPerDay}).`);
            }
        }
        function validateFormCompleteness() {
            let filledFields = 0;
            if (document.getElementById("image").files.length > 0) filledFields++;
            ["sharp_light","angle_45","full_plate","no_other_food"].forEach(name => {
                if (getRadioValue(name) !== null) filledFields++;
            });
            if (document.getElementById("prep").value) filledFields++;
            if (document.getElementById("portions").value) filledFields++;
            if (getIngredientsData().length > 0) filledFields++;
            if (filledFields < SPAM_PROTECTION.requiredFieldsCount) {
                throw new Error(`Bitte füllen Sie mindestens ${SPAM_PROTECTION.requiredFieldsCount} Felder aus. Aktuell: ${filledFields}`);
            }
        }
        function addHoneypot() {
            const honeypot = document.createElement('input');
            honeypot.type = 'text'; honeypot.name = 'website'; honeypot.style.display = 'none'; honeypot.tabIndex = -1; honeypot.autocomplete = 'off';
            document.getElementById('dataForm').appendChild(honeypot);
        }
        function checkHoneypot() {
            const honeypot = document.querySelector('input[name="website"]');
            if (honeypot && honeypot.value !== '') {
                throw new Error('Bot-Aktivität erkannt.');
            }
        }
        function getRadioValue(name) {
            const radio = document.querySelector(`input[name=\"${name}\"]:checked`);
            return radio ? radio.value === 'true' : null;
        }
        function getIngredientsData() {
            const ingredients = [];
            const rows = document.querySelectorAll('#ingredientsTable tbody tr');
            rows.forEach(row => {
                const name = row.cells[0].querySelector('input').value.trim();
                const amount = parseFloat(row.cells[1].querySelector('input').value);
                const unit = row.cells[2].querySelector('select').value;
                if (name && !isNaN(amount)) {
                    ingredients.push({ name, amount, unit });
                }
            });
            return ingredients;
        }
        function addIngredient() {
            const tbody = document.querySelector('#ingredientsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Zutat"></td>
                <td><input type="number" step="0.1" placeholder="Menge"></td>
                <td>
                    <select>
                        <option value="gr">Gramm</option>
                        <option value="ml">Milliliter</option>
                    </select>
                </td>
                <td><button type="button" onclick="removeIngredient(this)">Entfernen</button></td>
            `;
            tbody.appendChild(newRow);
        }
        function removeIngredient(button) { button.closest('tr').remove(); }
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        async function saveToCloudflare() {
            const saveButton = document.getElementById('saveButton');
            const imageInput = document.getElementById('image');
            try {
                checkHoneypot();
                checkSpamProtection();
                validateFormCompleteness();
                if (!imageInput.files.length) {
                    showStatus('Bitte wählen Sie ein Bild aus.', 'error');
                    return;
                }
                const imageFile = imageInput.files[0];
                if (imageFile.size > 10 * 1024 * 1024) {
                    showStatus('Bild ist zu groß (max. 10MB).', 'error');
                    return;
                }
                saveButton.disabled = true;
                showStatus('Speichere Daten...', 'loading');
                const ingredients = getIngredientsData();
                const timestamp = new Date().toISOString();
                const dataId = `data_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const metadata = {
                    id: dataId,
                    timestamp: timestamp,
                    image_name: imageFile.name,
                    view_angle: '45_degree',
                    full_plate: getRadioValue('full_plate'),
                    no_foreign_objects: !getRadioValue('no_other_food'),
                    sharp: getRadioValue('sharp_light'),
                    angle_correct: getRadioValue('angle_45'),
                    prep_method: document.getElementById('prep').value,
                    portions: parseInt(document.getElementById('portions').value),
                    ingredients: ingredients,
                    user_agent: navigator.userAgent.substring(0, 100),
                    upload_source: 'web_form_v1'
                };
                const imageKey = `images/${dataId}_${imageFile.name}`;
                await uploadToR2(imageKey, imageFile, 'image');
                const metadataBlob = new Blob([JSON.stringify(metadata, null, 2)], { type: 'application/json' });
                const metadataKey = `metadata/${dataId}.json`;
                await uploadToR2(metadataKey, metadataBlob, 'json');
                addUploadToHistory();
                showStatus('Daten erfolgreich gespeichert!', 'success');
                const history = getUploadHistory();
                const uploadsToday = history.length;
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                const uploadsThisHour = history.filter(t => t > oneHourAgo).length;
                setTimeout(() => {
                    showStatus(`Upload erfolgreich! Heute: ${uploadsToday}/${SPAM_PROTECTION.maxUploadsPerDay}, Diese Stunde: ${uploadsThisHour}/${SPAM_PROTECTION.maxUploadsPerHour}`, 'success');
                }, 2000);
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showStatus(error.message, 'error');
            } finally {
                saveButton.disabled = false;
            }
        }
        async function uploadToR2(key, file, type) {
            const url = 'https://quiet-brook-23c6.markusbaier2004.workers.dev/' + key;
            const headers = {
                'Authorization': `Bearer ${CLOUDFLARE_CONFIG.apiToken}`,
                'Content-Type': type === 'image' ? file.type : 'application/json'
            };
            const response = await fetch(url, { method: 'PUT', headers: headers, body: file });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Upload fehlgeschlagen (${response.status}): ${errorText}`);
            }
            return response;
        }
        async function testConnection() {
            showStatus('Teste Verbindung...', 'loading');
            try {
                const testBlob = new Blob(['Test'], { type: 'text/plain' });
                const testKey = `test/connection_test_${Date.now()}.txt`;
                await uploadToR2(testKey, testBlob, 'text');
                showStatus('✅ Token funktioniert! Verbindung erfolgreich.', 'success');
            } catch (error) {
                showStatus(`❌ Token-Fehler: ${error.message}`, 'error');
                console.error('Token-Test fehlgeschlagen:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            addHoneypot();
            const history = getUploadHistory();
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            if (history.length > 0) {
                showStatus(`Heute bereits ${history.length}/${SPAM_PROTECTION.maxUploadsPerDay} Uploads, diese Stunde: ${history.filter(t => t > oneHourAgo).length}/${SPAM_PROTECTION.maxUploadsPerHour}`, 'loading');
            }
        });
    </script>
</body>
</html>
